# åˆå§‹åŒ–åç«¯æœåŠ¡ï¼Œä½¿ç”¨æŠ€æœ¯æ ˆï¼šKoa2 + MongoDB

ğŸ”´ æ­£åœ¨ç¼–å†™...

### Koa2 é¡¹ç›®åˆå§‹åŒ–

```powershell
// 1. ç¡®ä¿å·²å®‰è£…node.js
$ node -v
// 2. ç¡®ä¿å·²å®‰è£…npmæˆ–yarn
$ npm -v æˆ– yarn -v
// 3. è¿›å…¥ç©ºé¡¹ç›®æ–‡ä»¶koa2(é¡¹ç›®å)ä¸­
$ cd koa2
// 4. åˆå§‹åŒ–package.json
$ yarn init
// 5. å®‰è£…koa
$ yarn add koa -s
```

1. æµ‹è¯•æœ€å°ç³»ç»Ÿ

1.1 æ–°å»º `app.js`

```JavaScript
const Koa = require("koa");
const app = new Koa();
app.use(async (ctx) => {
  ctx.body = "hello koa2";
});
app.listen(3000);
console.log("æœåŠ¡å™¨å¼€å¯: http://localhost:3000/");
```

1.2 è¿è¡Œç³»ç»Ÿ

```powershell
$ node app.js
```

1.3 æµè§ˆå™¨æ‰“å¼€

```
http://localhost:3000/
```

> ç»è¿‡ä¸Šé¢æœ€å°ç³»ç»Ÿçš„æµ‹è¯•,å¯ä»¥æ£€éªŒæˆ‘ä»¬é¡¹ç›®åˆå§‹åŒ–æ˜¯å¦æœ‰é—®é¢˜,å¯æ˜¯æˆ‘ä»¬åœ¨æ¥ä¸‹æ¥çš„å·¥ä½œä¸­å°†ä¼šå‡å°‘é”™è¯¯ã€‚

2. å®‰è£…ä¸­é—´ä»¶

-   koa-onerror é”™è¯¯ä¿¡æ¯
-   koa-bodyparser è§£æ body ä¸­ä¸­çš„ json è¯·æ±‚æ•°æ®
-   koa-logger æ—¥å¿—
-   koa-cors è·¨åŸŸ
-   koa-static é™æ€èµ„æº
-   koa-router è·¯ç”±
-   nodemon çƒ­æ›´æ–°
-   debug debug æ¨¡å¼
-   koa2-proxy-middleware ç”¨äºä»£ç†è½¬çš„ä¸­é—´ä»¶

```
$ yarn add koa-router koa-onerror koa-bodyparser koa-logger koa-cors koa-static nodemon debug koa2-proxy-middleware --save
```

3. å®‰è£…æ•°æ®åº“(è¯¦è§ä¸‹ä¸€èŠ‚)
   ç•¥
4. æœ€ç»ˆç›®å½•ç»“æ„

-   middelware ä¸­é—´ä»¶
-   controllerã€æ§åˆ¶å±‚ ä¸šåŠ¡ä»£ç 
-   config æ•°æ®åº“ç­‰è®¾ç½®
-   dbhelper sql è¯­å¥
-   routes è·¯ç”±
-   modal å¯¹è±¡å±‚

```
â”‚  app.js
â”‚  package.json
â”‚  REAAME.md
â”‚  yarn.lock
â”œâ”€app
â”‚  â”œâ”€controller
â”‚  â”‚   users.js
â”‚  â”‚
â”‚  â””â”€modal
â”‚      users.js
â”œâ”€bin
â”‚      www.js
â”œâ”€config
â”‚      constant.js
â”‚      database.js
â”‚      dbPool.js
â”œâ”€dbhelper
â”‚      users.js
â”œâ”€middlewares
â”‚  â”‚  index.js
â”‚  â””â”€middleware
â”‚     message.js
â”œâ”€routes
â”‚  â”‚  index.js
â”‚  â””â”€route
â”‚      users.js
â””â”€utils
       autoLoadFile.js
```

5. è¿›è¡ŒåŸºç¡€é…ç½®

5.1 æ”¹å†™`app.js`ï¼Œæ³¨å†Œä¸­é—´ä»¶

```JavaScript
const Koa = require("koa");
const app = new Koa();

const onerror = require("koa-onerror");
const bodyparser = require("koa-bodyparser");
const logger = require("koa-logger");
const router = require("./routes/index");
const cors = require("koa-cors");

// åœ¨ä½¿ç”¨koa2ä½œä¸ºå‰åç«¯åˆ†ç¦»çš„æ¡†æ¶ï¼Œå·¥ç¨‹å½“ä¸­çš„é™æ€é¡µé¢éœ€è¦è¯·æ±‚åœ¨å…¶ä»–åŸŸåä¸‹çš„æ¥å£ï¼Œç”±äºåŒæºç­–ç•¥çš„é™åˆ¶ï¼Œåœ¨koa2å·¥ç¨‹ä¸‹çš„é™æ€èµ„æºåªèƒ½é€šè¿‡nodeåç«¯è¿›è¡Œä»£ç†è¯·æ±‚å…¶ä»–åŸŸåä¸‹çš„æ¥å£ã€‚
const proxy = require('koa2-proxy-middleware');

// æ³¨å†Œerror
onerror(app);
// æ³¨å†Œbodyparser
app.use(bodyparser());
// æ³¨å†Œæ—¥å¿—
app.use(logger());
// æ³¨å†Œé™æ€èµ„æº
app.use(require("koa-static")(__dirname + "/public"));
// æ³¨å†Œè·¨åŸŸ
app.use(cors());
// æ³¨å†Œè‡ªå®šä¹‰ä¸­é—´ä»¶
require('./middlewares/index')(app);
// æ³¨å†Œè·¯ç”±
app.use(router.routes(), router.allowedMethods());

// é…ç½®koa2-proxy-middlewareç”¨äºä»£ç†è½¬çš„ä¸­é—´ä»¶ã€‚
const options = {
  targets: {
    '/aktools/(.*)': {
      target: 'http://127.0.0.1:8080/',
      ws: true,
      changeOrigin: true,
      pathRewrite: {
        '^/aktools/': '/api/public/'
      }
    },
  }
}
app.use(proxy(options));

// logger-handling
app.use(async (ctx, next) => {
  const start = new Date();
  await next();
  const ms = new Date() - start;
  console.log(`${ctx.method} ${ctx.url} - ${ms}ms`);
});
// error-handling
app.on("error", (err, ctx) => {
  console.error("server error", err, ctx);
});

module.exports = app;
```

`koa-onerror`ã€`koa-bodyparser`ã€`koa-logger`ã€`koa-cors`ç­‰ä¸­é—´ä»¶ä¸º`koa`å¸¸è§ä¸­é—´ä»¶ï¼Œè¿™é‡Œä¸å†è¿‡å¤šä»‹ç»ç”¨æ³•ã€‚
`koa-router`å’Œ`middlewares`åšäº†ä¸€äº›è‡ªå®šä¹‰æ“ä½œï¼Œä¸‹é¢ä¼šä»‹ç»åˆ°

5.2 åˆ›å»ºå…¥å£æ–‡ä»¶ `bin/www`

```JavaScript
#!/usr/bin/env node
/**
 * Module dependencies.
 */
var app = require('../app');
var debug = require('debug')('demo:server');
var http = require('http');
/**
 * Get port from environment and store in Express.
 */
var port = normalizePort('3000');
/**
 * Create HTTP server.
 */
var server = http.createServer(app.callback());
/**
 * Listen on provided port, on all network interfaces.
 */
server.listen(port);
server.on('error', onError);
server.on('listening', onListening);
/**
 * Normalize a port into a number, string, or false.
 */
function normalizePort(val) {
  var port = parseInt(val, 10);
  if (isNaN(port)) {
    // named pipe
    return val;
  }
  if (port >= 0) {
    // port number
    return port;
  }
  return false;
}
/**
 * Event listener for HTTP server "error" event.
 */
function onError(error) {
  if (error.syscall !== 'listen') {
    throw error;
  }
  var bind = typeof port === 'string'
    ? 'Pipe ' + port
    : 'Port ' + port;
  // handle specific listen errors with friendly messages
  switch (error.code) {
    case 'EACCES':
      console.error(bind + ' requires elevated privileges');
      //  process.exit(1);
      break;
    case 'EADDRINUSE':
      console.error(bind + ' is already in use');
      //  process.exit(1);
      break;
    default:
      throw error;
  }
}
/**
 * Event listener for HTTP server "listening" event.
 */
function onListening() {
  var addr = server.address();
  var bind = typeof addr === 'string'
    ? 'pipe ' + addr
    : 'port ' + addr.port;
  debug('Listening on ' + bind);
}

```

5.3 æ”¹å†™`package.json`ï¼Œæ·»åŠ å¯åŠ¨è„šæœ¬

```JSON
"scripts": {
    "start": "node bin/www",
    "dev": "nodemon bin/www"
}
```

6. è·¯ç”±é…ç½®

-   å°†è·¯ç”±æŒ‰æ¨¡å—æ‹†åˆ†,æ–¹ä¾¿è·¯ç”±è§£è€¦ã€‚
-   å°†æ³¨å†Œè·¯ç”±ä¸ä¸šåŠ¡å±‚è§£è€¦,æ–¹ä¾¿ä¸šåŠ¡é€»è¾‘å¤ç”¨ã€‚
-   åœ¨è·¯ç”±æ¨¡å—æ·»åŠ è·¯ç”±å‰ç¼€,ä½¿è·¯ç”±æ›´æ˜“æ‡‚æ˜“è¯»ã€‚

6.1 å®ç°è‡ªåŠ¨åŠ è½½æ–‡ä»¶å‡½æ•°ï¼Œåˆ›å»ºæ–‡ä»¶`utils/autoLoadFile.js`

```JavaScript
#!/usr/bin/env node
const path = require("path");
const fs = require("fs");
const getPathInfo = (p) => path.parse(p);

/**
 * @description // é€’å½’è¯»å–æ–‡ä»¶ï¼Œç±»ä¼¼äºwebpackçš„require.context()
 * @param {String} directory æ–‡ä»¶ç›®å½•
 * @param {Boolean} useSubdirectories æ˜¯å¦æŸ¥è¯¢å­ç›®å½•ï¼Œé»˜è®¤false
 * @param {array} extList æŸ¥è¯¢æ–‡ä»¶åç¼€ï¼Œé»˜è®¤ ['.js']
 */
const autoLoadFile = (
  directory,
  useSubdirectories = false,
  extList = [".js"]
) => {
  const filesList = [];
  // é€’å½’è¯»å–æ–‡ä»¶
  function readFileList(directory, useSubdirectories, extList) {
    const files = fs.readdirSync(directory);
    files.forEach((item) => {
      const fullPath = path.join(directory, item);
      const stat = fs.statSync(fullPath);
      if (stat.isDirectory() && useSubdirectories) {
        readFileList(path.join(directory, item), useSubdirectories, extList);
      } else {
        const info = getPathInfo(fullPath);
        extList.includes(info.ext) && filesList.push(fullPath);
      }
    });
  }
  readFileList(directory, useSubdirectories, extList);
  // ç”Ÿæˆéœ€è¦çš„å¯¹è±¡
  const res = filesList.map((item) => ({
    path: item,
    data: require(item),
    ...getPathInfo(item),
  }));
  return res;
};
module.exports = autoLoadFile;
```

ä½¿ç”¨ç¤ºä¾‹ï¼š

```JavaScript
const context = require("../utils/autoLoadFile");
const fileList = context(path.join(__dirname, "./route"), true);
```

6.2 è·¯ç”±è‡ªæ³¨å†Œï¼Œåˆ›å»ºè·¯ç”±è‡ªæ‰§è¡Œæ–‡ä»¶ `routes/index.js`

```JavaScript
const router = require("koa-router")();
const path = require("path");
const context = require("../utils/autoLoadFile");

/**
 * @param {Array} arr éœ€è¦æ³¨å†Œè·¯ç”±çš„æ–‡ä»¶åˆ—è¡¨
 */
function importAll(arr) {
  arr.forEach((key) => {
    // è¿™ç§æ–¹å¼ä¸ºåµŒå¥—è·¯ç”±
    router.use("/api", key.data.routes(), key.data.allowedMethods());
  });
}
importAll(context(path.join(__dirname, "./route"), false));

module.exports = router;
```

6.3 æ³¨å†Œè·¯ç”±

```JavaScript
// app.js
// å¼•å…¥è·¯ç”±è‡ªæ‰§è¡Œæ–‡ä»¶
const router = require("./routes/index");
// æ³¨å†Œè·¯ç”±
app.use(router.routes(), router.allowedMethods());
```

6.4 åˆ›å»ºè·¯ç”±æ¨¡å—ï¼ŒåŸºç¡€æ­å»ºå·²ç»å¥½äº†,åˆ›å»ºä¸€ä¸ªæ¨¡å—è¯•è¯•

```JavaScript
// routes/route/users.js
const router = require("koa-router")();
// æ¨¡å—è·¯ç”±å‰ç¼€
router.prefix("/users");
router.post("/", function (ctx, next) {
	ctx.body = "this a users response!";
});
/**
 * ç”¨æˆ·ç™»å½•æ¥å£
 * @param {username} ç”¨æˆ·å
 * @param {password} ç”¨æˆ·å¯†ç 
 */
router.post("/login", async (ctx) => {
	const request = ctx.request.body;
	const { username, password } = request;
	if(username && password) {
	    ctx.body = {
	        "code":200,
          "msg":"success",
          "data": "ç™»å½•æˆåŠŸ"
	    }
	}
});
module.exports = router;
```

æœ€ç»ˆè·¯ç”± path: `localhost:3000/api/users/login`

-   `/api` ä¸ºè·¯ç”±å‰ç¼€
-   `/users` ä¸ºæ¨¡å—è·¯ç”±å‰ç¼€
-   `/login` å…·ä½“æ¥å£

7. ä¸­é—´ä»¶é…ç½®

7.1 ä¸­é—´ä»¶è‡ªæ³¨å†Œï¼Œåˆ›å»ºè‡ªæ‰§è¡Œæ–‡ä»¶ `middlewares/index.js`

```JavaScript
const path = require("path");
const context = require("../utils/autoLoadFile");
/**
 * @param {Array} arr éœ€è¦æ³¨å†Œä¸­é—´ä»¶çš„æ–‡ä»¶åˆ—è¡¨
 */
const install = (app) => {
  context(path.join(__dirname, "./middleware"), false).forEach((key) => {
    app.use(key.data);
  });
};
module.exports = install;
```

7.2 ä¸­é—´ä»¶æ³¨å†Œ

```JavaScript
// app/js
// æ³¨å†Œè‡ªå®šä¹‰ä¸­é—´ä»¶
require('./middlewares/index')(app);
```

7.3 å“åº”ä½“ä¸­é—´ä»¶ï¼Œåˆ›å»ºå°è£…å“åº”ä½“çš„ä¸­é—´ä»¶ `message.js`

```JavaScript
// middlewares/middleware/message.js
module.exports = async (ctx, next) => {
  ctx.res.$success = (data, code = 200) => {
    const _data = {
      code,
    };
    if (typeof data === "object") {
      _data.msg = "success";
      _data.data = data;
    } else {
      _data.msg = data;
    }
    ctx.body = _data;
  };
  ctx.res.$error = (err, code = 500) => {
    const _data = {
      code,
    };
    if (typeof err === "object") {
      _data.msg = "error";
      _data.data = JSON.stringify(err);
    } else {
      _data.msg = err;
    }
    ctx.body = _data;
  };
  await next();
};
```

7.4 å“åº”ä½“ä¸­é—´ä»¶ä½¿ç”¨ç¤ºä¾‹

```JavaScript
router.post('/login', async (ctx) => {
  const request = ctx.request.body;
  const { username, password } = request;
  if (username&&password) {
    ctx.res.$success('ç™»å½•æˆåŠŸ');
  } else {
    ctx.res.$error("è¯·æ±‚å¤±è´¥", 403);
  }
})
```

7.5 å“åº”ä½“ä¸­é—´ä»¶ç»“æœ

```JavaScript
// æˆåŠŸ
{
    "code":200,
    "msg":"success",
    "data":"ç™»å½•æˆåŠŸ"
}

// å¤±è´¥
{
    "code":403,
    "msg":"error",
    "data":"è¯·æ±‚å¤±è´¥"
}
```

### MongoDB å®‰è£…å’Œé…ç½®
