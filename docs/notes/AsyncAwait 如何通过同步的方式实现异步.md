# `Async/Await` å¦‚ä½•é€šè¿‡åŒæ­¥çš„æ–¹å¼å®ç°å¼‚æ­¥

é¦–å…ˆæƒ³è¦æ›´å¥½çš„ç†è§£ `Async/Await`ï¼Œéœ€è¦äº†è§£è¿™ä¸¤ä¸ªçŸ¥è¯†ç‚¹ï¼š

-   åŒæ­¥
-   å¼‚æ­¥

é¦–å…ˆï¼Œ`JavaScript` æ˜¯å•çº¿ç¨‹çš„ï¼ˆé‡å¤ä¸‰éï¼‰ï¼Œæ‰€è°“å•çº¿ç¨‹ï¼Œå°±æ˜¯æ‰§è¡Œä»£ç æ˜¯ä¸€è¡Œä¸€è¡Œçš„å¾€ä¸‹èµ°ï¼ˆå³æ‰€è°“çš„åŒæ­¥ï¼‰ï¼Œå¦‚æœä¸Šé¢çš„æ²¡æ‰§è¡Œå®Œï¼Œå°±ç—´ç—´çš„ç­‰ç€ï¼Œä¸¾ä¸ªä¾‹å­ï¼š

```JavaScript
// chrome 81
function test() {
  let d = Date.now();
  for (let i = 0; i < 1e8; i++) {}
  console.log(Date.now() - d); // 62ms-90mså·¦å³
}
function test1() {
  let d = Date.now();
  console.log(Date.now() - d); // 0
}
test();
test1();
```

ä¸Šé¢ä»…ä»…æ˜¯ä¸€ä¸ª `for` å¾ªç¯ï¼Œè€Œåœ¨å®é™…åº”ç”¨ä¸­ï¼Œä¼šæœ‰å¤§é‡çš„ç½‘ç»œè¯·æ±‚ï¼Œå®ƒçš„å“åº”æ—¶é—´æ˜¯ä¸ç¡®å®šçš„ï¼Œè¿™ç§æƒ…å†µä¸‹ä¹Ÿè¦ç—´ç—´çš„ç­‰ä¹ˆï¼Ÿæ˜¾ç„¶æ˜¯ä¸è¡Œçš„ï¼Œå› è€Œ `JavaScript` è®¾è®¡äº†å¼‚æ­¥ï¼Œå³å‘èµ·ç½‘ç»œè¯·æ±‚ï¼ˆè¯¸å¦‚ IO æ“ä½œï¼Œå®šæ—¶å™¨ï¼‰ï¼Œç”±äºéœ€è¦ç­‰æœåŠ¡å™¨å“åº”ï¼Œå°±å…ˆä¸ç†ä¼šï¼Œè€Œæ˜¯å»åšå…¶ä»–çš„äº‹å„¿ï¼Œç­‰è¯·æ±‚è¿”å›äº†ç»“æœçš„æ—¶å€™å†è¯´ï¼ˆå³å¼‚æ­¥ï¼‰ã€‚

é‚£ä¹ˆå¦‚ä½•å®ç°å¼‚æ­¥å‘¢ï¼Ÿå…¶å®æˆ‘ä»¬å¹³æ—¶å·²ç»åœ¨å¤§é‡ä½¿ç”¨äº†ï¼Œé‚£å°±æ˜¯ `callback`ï¼Œä¾‹å¦‚ï¼š

```JavaScript
// ç½‘ç»œè¯·æ±‚
$.ajax({
  url: 'http://xxx',
  success: function(res) {
    console.log(res);
  },
});
```

`success` ä½œä¸ºå‡½æ•°ä¼ é€’è¿‡å»å¹¶ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯ç­‰è¯·æ±‚æˆåŠŸäº†æ‰æ‰§è¡Œï¼Œå³å›è°ƒå‡½æ•°`callback`:

```JavaScript
// IOæ“ä½œ
const fs = require('fs');

fs.rename('æ—§æ–‡ä»¶.txt', 'æ–°æ–‡ä»¶.txt', err => {
  if (err) throw err;
  console.log('é‡å‘½åå®Œæˆ');
});
```

å’Œç½‘ç»œè¯·æ±‚ç±»ä¼¼ï¼Œç­‰åˆ° IO æ“ä½œæœ‰äº†ç»“æœï¼ˆæ— è®ºæˆåŠŸä¸å¦ï¼‰æ‰ä¼šæ‰§è¡Œç¬¬ä¸‰ä¸ªå‚æ•°ï¼š`(err)=>{}`
ä»ä¸Šé¢æˆ‘ä»¬å°±å¯ä»¥çœ‹å‡ºï¼Œå®ç°å¼‚æ­¥çš„æ ¸å¿ƒå°±æ˜¯å›è°ƒé’©å­ï¼Œå°† `callback` ä½œä¸ºå‚æ•°ä¼ é€’ç»™å¼‚æ­¥æ‰§è¡Œå‡½æ•°ï¼Œå½“æœ‰äº†ç»“æœååœ¨è§¦å‘ `callback`ã€‚
è‡³äº `async/await` æ˜¯å¦‚ä½•å‡ºç°çš„å‘¢ï¼Œåœ¨ `es6` ä¹‹å‰ï¼Œå¤§å¤š `JavaScript` æ•°é¡¹ç›®ä¸­ä¼šæœ‰ç±»ä¼¼è¿™æ ·çš„ä»£ç ï¼š

```JavaScript
ajax1(url, () => {
  // do something 1
  ajax2(url, () => {
    // do something 2
    ajax3(url, () => {
      // do something 3
      // ...
    });
  });
});
```

è¿™ç§å‡½æ•°åµŒå¥—ï¼Œå¤§é‡çš„å›è°ƒå‡½æ•°ï¼Œä½¿ä»£ç é˜…è¯»èµ·æ¥æ™¦æ¶©éš¾æ‡‚ï¼Œä¸ç›´è§‚ï¼Œå½¢è±¡çš„ç§°ä¹‹ä¸ºå›è°ƒåœ°ç‹±(callback hell)ï¼Œæ‰€ä»¥ä¸ºäº†åœ¨å†™æ³•ä¸Šèƒ½æ›´é€šä¿—ä¸€ç‚¹ï¼Œes6+é™†ç»­å‡ºç°äº† `Promise`ã€`Generator`ã€`Async/await`ï¼ŒåŠ›æ±‚åœ¨å†™æ³•ä¸Šç®€æ´æ˜äº†ï¼ˆæ‰å¹³åŒ–ï¼‰ï¼Œå¯è¯»æ€§å¼ºï¼ˆæ›´ä¼˜é›…ã€æ›´ç®€æ´ï¼‰ã€‚

**`async/await` æ˜¯å‚ç…§ `Generator` å°è£…çš„ä¸€å¥—å¼‚æ­¥å¤„ç†æ–¹æ¡ˆï¼Œå¯ä»¥ç†è§£ä¸º `Generator` çš„è¯­æ³•ç³–ã€‚**

> `async/await` æ˜¯ ES2017 å¼•å…¥çš„æ–°è¯­æ³•ï¼Œç”¨äºæ›´ç®€æ´åœ°å¤„ç† `JavaScript` å¼‚æ­¥æ“ä½œã€‚å®ƒä¸ `Generator` æœ‰å¯†åˆ‡å…³ç³»ï¼Œå†…éƒ¨å®ç°ä¸Šä½¿ç”¨äº† `Generator` çš„è‡ªåŠ¨æ‰§è¡Œå™¨ã€‚ä»è¯­æ³•ä¸Šæ¥çœ‹,`async/await` çœ‹èµ·æ¥æ›´åƒåŒæ­¥ä»£ç ï¼Œé¿å…äº† `Generator` é‚£ç§æµç¨‹æ§åˆ¶å‹çš„æ˜Ÿå·å’Œ `yield` è¯­æ³•ã€‚`async/await` å¯ä»¥è®¤ä¸ºæ˜¯ `Generator` çš„è¯­æ³•ç³–ï¼Œæä¾›äº†ä¸€ç§æ›´å‹å¥½çš„è¯­æ³•æ–¹å¼æ¥ç¼–å†™å¼‚æ­¥ä»£ç ã€‚ä½¿ç”¨ `async/await` æˆ‘ä»¬å¯ä»¥å†™å‡ºæ›´ç±»ä¼¼åŒæ­¥ä»£ç çš„å¼‚æ­¥é€»è¾‘ï¼Œä½†å…¶ä»ç„¶æ˜¯éé˜»å¡çš„å¼‚æ­¥æ“ä½œã€‚`async/await` å»ºç«‹åœ¨ `Promise` çš„åŸºç¡€ä¸Šï¼Œåˆ©ç”¨ `Promise` å¯¹è±¡å¤„ç†å¼‚æ­¥æ“ä½œç»“æœã€‚`async` å£°æ˜ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œ`await` ç”¨äºç­‰å¾…ä¸€ä¸ªå¼‚æ­¥æ“ä½œå®Œæˆè·å–ç»“æœã€‚

#### ä»€ä¹ˆæ˜¯ `Generator` ï¼Ÿ

`Generator`(ç”Ÿæˆå™¨)æ˜¯`ES6`ä¸­æ–°å¢çš„ä¸€ç§å¼‚æ­¥ç¼–ç¨‹è§£å†³æ–¹æ¡ˆã€‚å…¶ä¸»è¦ç‰¹å¾åŒ…æ‹¬:

-   `Generator` å‡½æ•°ç”± `function *`å®šä¹‰ï¼Œå†…éƒ¨å¯ä»¥é€šè¿‡ `yield` æš‚åœæ‰§è¡Œã€‚
-   è°ƒç”¨ `Generator` å‡½æ•°åï¼Œå¹¶ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªè¿­ä»£å™¨å¯¹è±¡ã€‚
-   é€šè¿‡è¿­ä»£å™¨çš„ `next()` æ–¹æ³•å¯ä»¥åˆ†æ®µæ‰§è¡Œ `Generator` å‡½æ•°å†…éƒ¨çš„ä»£ç ã€‚
-   æ¯æ¬¡è°ƒç”¨ `next()` ä¼šæ‰§è¡Œè‡³ä¸‹ä¸€ä¸ª `yield` è¯­å¥ä¸ºæ­¢ï¼Œ`yield` è¯­å¥å¯ä»¥è¿”å›å€¼ï¼Œä½œä¸º `next()` çš„è¿”å›å€¼ã€‚
-   `Generator` å¯ä»¥ç”¨äºå¤„ç†å›è°ƒé‡‘å­—å¡”é—®é¢˜ï¼Œä¹Ÿå¯ä»¥é…åˆ `Promise` ç­‰å¼‚æ­¥ç¼–ç¨‹æ–¹å¼ä½¿ç”¨ã€‚
-   éœ€è¦æ³¨æ„ `Generator` å‡½æ•°æœ¬èº«æ˜¯åŒæ­¥çš„ï¼Œå¼‚æ­¥æ•ˆæœéœ€è¦é…åˆå…¶ä»–å¼‚æ­¥æ“ä½œå®ç°ã€‚
-   `Generator` å·²è¢« `async/await` ç­‰æ–°æ–¹æ¡ˆå¤§é‡å–ä»£ï¼Œä½†ä»ç„¶å¯ä»¥æä¾›å¼ºå¤§çš„å¼‚æ­¥æ§åˆ¶èƒ½åŠ›ã€‚

æ€»ç»“æ¥è¯´ï¼Œ`Generator` å‡½æ•°å¯ä»¥åˆ†æ®µæ‰§è¡Œï¼Œ`Yield` è¡¨è¾¾å¼å¯ä»¥äº¤å‡ºå‡½æ•°çš„æ§åˆ¶æƒï¼Œè¿™ä¸ºå¼‚æ­¥ç¼–ç¨‹æä¾›äº†å¯èƒ½ã€‚å®ƒå¼€å¯äº† `JavaScript` å¼‚æ­¥ç¼–ç¨‹çš„æ–°ç¯‡ç« ã€‚

#### `Yield`è¡¨è¾¾å¼å¯ä»¥äº¤å‡ºå‡½æ•°çš„æ§åˆ¶æƒï¼Œè°æ‹¿åˆ°è¿™ä¸ªæ§åˆ¶æƒï¼Ÿ

åœ¨ `Generator` å‡½æ•°ä¸­ï¼Œ`yield` è¡¨è¾¾å¼å¯ä»¥äº¤å‡ºå‡½æ•°çš„æ‰§è¡Œæ§åˆ¶æƒï¼Œé‚£ä¹ˆè¿™ä¸ªæ§åˆ¶æƒå…·ä½“äº¤ç»™è°å‘¢ï¼Ÿ

-   å½“ `Generator` å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œä¼šè¿”å›ä¸€ä¸ªè¿­ä»£å™¨å¯¹è±¡ã€‚è¿™ä¸ªè¿­ä»£å™¨å¯¹è±¡æ‹¿åˆ°äº† `Generator` å‡½æ•°çš„æ§åˆ¶æƒã€‚
-   é€šè¿‡è¿­ä»£å™¨çš„ `next()` æ–¹æ³•å¯ä»¥æ¢å¤æ‰§è¡Œ `Generator` å‡½æ•°,æ¯æ¬¡ `next()` è°ƒç”¨ä¼šæ‰§è¡Œåˆ°ä¸‹ä¸€ä¸ª `yield` ä½ç½®ä¸ºæ­¢ã€‚
-   æ‰€ä»¥å¯ä»¥è¯´ï¼Œ`yield` è¡¨è¾¾å¼å°†æ§åˆ¶æƒäº¤ç»™äº†è°ƒç”¨å®ƒçš„è¿­ä»£å™¨å¯¹è±¡ã€‚
-   è¿­ä»£å™¨å¯¹è±¡å¯ä»¥å†³å®šä½•æ—¶æ¢å¤ `Generator` å‡½æ•°çš„æ‰§è¡Œ,ä»¥åŠä¼ å…¥ä½•å€¼ç»™ `yield` è¡¨è¾¾å¼ã€‚
-   æˆ‘ä»¬é€šå¸¸ä¸ä¼šç›´æ¥ä½¿ç”¨è¿­ä»£å™¨å¯¹è±¡,è€Œæ˜¯é€šè¿‡ `Generator` å‡½æ•°çš„è‡ªåŠ¨æ‰§è¡Œå™¨,æ¯”å¦‚ `Thunk` å‡½æ•°ã€`Promise` ç­‰ã€‚
-   è¿™äº›è‡ªåŠ¨æ‰§è¡Œå™¨ä¼šåå¤è°ƒç”¨è¿­ä»£å™¨çš„ `next()` æ–¹æ³•,ä»è€Œæ¥ç®¡ `Generator` çš„æ§åˆ¶æƒ,å®ç°å¼‚æ­¥æµç¨‹ç®¡ç†ã€‚

ç®€å•æ¥è¯´ï¼Œ`yield` è¡¨è¾¾å¼äº¤å‡ºçš„æ§åˆ¶æƒ,æ˜¯ç»™è°ƒç”¨å®ƒçš„è¿­ä»£å™¨å¯¹è±¡çš„ã€‚è€Œæˆ‘ä»¬é€šè¿‡è®©è‡ªåŠ¨æ‰§è¡Œå™¨æ¥è°ƒç”¨è¿™ä¸ªè¿­ä»£å™¨,å®ç°å¯¹ `Generator` çš„é©±åŠ¨,ä»è€Œå®ç°å¼‚æ­¥ç¼–ç¨‹ã€‚
é€šè¿‡ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ä»£ç æ¥è§£é‡Š `yield` è¡¨è¾¾å¼äº¤å‡ºæ§åˆ¶æƒçš„è¿‡ç¨‹:

```JavaScript
// ä¸€ä¸ª Generator å‡½æ•°
function* genFunc() {
  console.log('ä»£ç æ®µ1')
  yield 'yieldç‚¹1'
  console.log('ä»£ç æ®µ2')
  yield 'yieldç‚¹2'
  console.log('ä»£ç æ®µ3')
}

// è°ƒç”¨å‡½æ•°,è·å–è¿­ä»£å™¨å¯¹è±¡
const iterator = genFunc()

// ç¬¬ä¸€æ¬¡è°ƒç”¨next(),æ‰§è¡Œåˆ°ç¬¬ä¸€ä¸ªyieldä¸ºæ­¢
iterator.next()
// è¾“å‡º:ä»£ç æ®µ1

// å†æ¬¡è°ƒç”¨next(),æ‰§è¡Œåˆ°ç¬¬äºŒä¸ªyieldä¸ºæ­¢
iterator.next()
// è¾“å‡º:ä»£ç æ®µ2

// å†æ¬¡è°ƒç”¨next(),æ‰§è¡Œåˆ°å‡½æ•°ç»“æŸ
iterator.next()
// è¾“å‡º:ä»£ç æ®µ3
```

é€šè¿‡è¿™ä¸ªç¤ºä¾‹å¯ä»¥çœ‹å‡º:

-   `Generator` å‡½æ•°æ‰§è¡Œåä¼šè¿”å›ä¸€ä¸ªè¿­ä»£å™¨å¯¹è±¡ `iterator`
-   æ¯æ¬¡è°ƒç”¨ `iterator` çš„ `next()` æ–¹æ³•,ä¼šæ¢å¤æ‰§è¡Œ `Generator` å‡½æ•°,é‡åˆ° `yield` è¡¨è¾¾å¼å°±æš‚åœ
-   è¿™æ ·æ§åˆ¶æƒå°±é€šè¿‡ `yield` è¡¨è¾¾å¼äº¤ç»™äº†è°ƒç”¨å®ƒçš„è¿­ä»£å™¨ `iterator`
-   è¿­ä»£å™¨å¯ä»¥å†³å®šä½•æ—¶é€šè¿‡ `next()` æ¢å¤æ‰§è¡Œ `Generator` å‡½æ•°

è¿™æ ·å°±å®ç°äº† `Generator` çš„æ§åˆ¶æƒäº¤æ¥,ä»è€Œå¯ä»¥ç”¨äºå¼‚æ­¥ç¼–ç¨‹åœºæ™¯ä¸­ã€‚åŒæ—¶æˆ‘ä»¬è¿˜èƒ½çœ‹åˆ°ï¼Œå¯ä»¥çœ‹åˆ°,å‡½æ•°å†…éƒ¨çš„æ—¥å¿—ä»£ç æ˜¯é¡ºåºåŒæ­¥æ‰§è¡Œçš„ã€‚ä¹‹æ‰€ä»¥èƒ½å®ç°å¼‚æ­¥æ•ˆæœ,æ˜¯å› ä¸ºå¯ä»¥é€šè¿‡ `yield` ä¸­æ–­å‡½æ•°æ‰§è¡Œæµç¨‹,è¿›è¡Œä¿¡æ¯äº¤æ¢ã€‚æ‰€ä»¥è¯´ï¼Œæ­¤æ—¶çš„å¼‚æ­¥å¹¶ä¸æ˜¯çœŸæ­£çš„å¼‚æ­¥,è€Œæ˜¯åˆ©ç”¨åŒæ­¥ä»£ç å®ç°çš„æ¨¡æ‹Ÿå¼‚æ­¥ã€‚çœŸæ­£çš„å¼‚æ­¥éœ€è¦ `Generator` é…åˆ `Promise`ã€äº‹ä»¶ç›‘å¬ç­‰æœºåˆ¶,å°†æ§åˆ¶æƒå®Œå…¨äº¤å‡º,ä»è€Œå®ç°å¯¹å¼‚æ­¥æ“ä½œçš„ç­‰å¾…ã€‚è¿™ä¹Ÿæ˜¯ç†è§£ `Generator` å¼‚æ­¥æ•ˆæœçš„å…³é”®ã€‚

#### ä¸‹é¢æˆ‘ä»¬ç”¨ä¸€æ®µä»£ç æ¼”ç¤º `Generator` æ˜¯å¦‚ä½•é…åˆ `Promise` å®ç°å¼‚æ­¥æ“ä½œçš„

```JavaScript
function getUser() {
  return new Promise(resolve => {
    setTimeout(() => {
      resolve({ name: 'John' });
    }, 1000);
  });
}
function* main() {
  const user = yield getUser();
  console.log(user);
}
const g = main();
g.next().value.then(data => {
  g.next(data);
});
```

åœ¨ä¸Šè¿°ä»£ç ä¸­:

-   `getUser` è¿”å›ä¸€ä¸ª `Promise`
-   åœ¨ `Generator` ä¸­é€šè¿‡ `yield` è·å– `Promise` çš„ç»“æœ `user`
-   `yield` åçš„ `getUser()` ä¼šç«‹å³æ‰§è¡Œå¹¶è¿”å› `Promise` å¯¹è±¡
-   é€šè¿‡ `g.next().value` å¯ä»¥è·å–è¿™ä¸ª `Promise` å¯¹è±¡
-   ç„¶ååœ¨ `Promise` çš„ `then` å›è°ƒä¸­,å°†ç»“æœæ•°æ®ä¼ å…¥ `g.next(data)`,æ¢å¤ `Generator` çš„æ‰§è¡Œ
-   è¿™æ ·å½“ `Promise resolve` å,å°±å¯ä»¥åœ¨ `Generator` å†…éƒ¨é€šè¿‡ `yield` æ‹¿åˆ°ç»“æœäº†

é€šè¿‡ä¸Šé¢è¿™ç§é…åˆ,`Generator` å’Œ `Promise` å¯ä»¥åä½œ,ä»è€Œå®ç°çœŸæ­£çš„å¼‚æ­¥ä»£ç çš„åŒæ­¥åŒ–å¤„ç†ã€‚

çœ‹åˆ°è¿™é‡Œï¼Œä½ å¯èƒ½ä¼šé—®ï¼Œ`Generator` å’Œ `callback` æœ‰å•¥å…³ç³»ï¼Œå¦‚ä½•å¤„ç†å¼‚æ­¥å‘¢ï¼Ÿå…¶å®äºŒè€…æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œæˆ‘ä»¬åªæ˜¯é€šè¿‡ä¸€äº›æ–¹å¼å¼ºè¡Œçš„å®ƒä»¬äº§ç”Ÿäº†å…³ç³»ï¼Œæ‰ä¼šæœ‰ `Generator` å¤„ç†å¼‚æ­¥ã€‚

æˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹ `Generator` çš„æœ¬è´¨ï¼šæš‚åœï¼Œå®ƒä¼šè®©ç¨‹åºæ‰§è¡Œåˆ°æŒ‡å®šä½ç½®å…ˆæš‚åœï¼ˆ`yield`ï¼‰ï¼Œç„¶åå†å¯åŠ¨ï¼ˆ`next`ï¼‰ï¼Œå†æš‚åœï¼ˆ`yield`ï¼‰ï¼Œå†å¯åŠ¨ï¼ˆ`next`ï¼‰ï¼Œè€Œè¿™ä¸ªæš‚åœå°±å¾ˆå®¹æ˜“è®©å®ƒå’Œå¼‚æ­¥æ“ä½œäº§ç”Ÿè”ç³»ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨å¤„ç†å¼‚æ­¥æ—¶ï¼šå¼€å§‹å¼‚æ­¥å¤„ç†ï¼ˆç½‘ç»œæ±‚æƒ…ã€IO æ“ä½œï¼‰ï¼Œç„¶åæš‚åœä¸€ä¸‹ï¼Œç­‰å¤„ç†å®Œäº†ï¼Œå†è¯¥å¹²å˜›å¹²å˜›ã€‚ä¸è¿‡å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ`JavaScript` æ˜¯å•çº¿ç¨‹çš„ï¼Œå¼‚æ­¥è¿˜æ˜¯å¼‚æ­¥ï¼Œ`callback` è¿˜æ˜¯ `callback`ï¼Œä¸ä¼šå› ä¸º `Generator` è€Œæœ‰ä»»ä½•æ”¹å˜ã€‚

#### æ€ä¹ˆè¿˜æ²¡è®²åˆ° `async/await` ğŸ’¢

æ¥äº†æ¥äº†â€¦â€¦ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼Œ`async/await` æ˜¯ `Generator` çš„è¯­æ³•ç³–ï¼Œå…ˆä¸Šä¸€æ®µä»£ç çœ‹ä¸€ä¸‹ä¸¤è€…çš„å¯¹æ¯”ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬å®ç°ä¸€ä¸ªé’ˆå¯¹ `Generator` å‡½æ•°çš„è‡ªåŠ¨æ‰§è¡Œå™¨ `run` ,å¯ä»¥è‡ªåŠ¨æ‰§è¡Œ `Generator` å‡½æ•°å†…çš„å¼‚æ­¥é€»è¾‘ã€‚

```JavaScript
function run(gen) {
  const g = gen(); // `run` æ¥æ”¶ä¸€ä¸ª `Generator` å‡½æ•°ä½œä¸ºå‚æ•°ã€‚åœ¨å†…éƒ¨ï¼Œè°ƒç”¨è¯¥ `Generator` å‡½æ•°,å¹¶èµ‹å€¼ç»™å˜é‡ `g`ã€‚
  function next(data) { // å®šä¹‰ `next` å‡½æ•°,ç”¨æ¥æ‰§è¡Œ `Generator` çš„æ¯ä¸€æ­¥ã€‚
    const res = g.next(data); // åœ¨ `next` å†…éƒ¨ï¼Œé¦–å…ˆè°ƒç”¨ `g.next(data)` æ‰§è¡Œå½“å‰æ­¥ï¼Œè·å–è¿”å›ç»“æœ `res`ã€‚
    // æ·±åº¦é€’å½’ï¼Œåªè¦ `Generator` å‡½æ•°è¿˜æ²¡æ‰§è¡Œåˆ°æœ€åä¸€æ­¥ï¼Œ`next` å‡½æ•°å°±è°ƒç”¨è‡ªèº«
    if (res.done) return res.value; // æ£€æŸ¥ `res.done`ï¼Œå¦‚æœä¸º `true`ï¼Œè¡¨ç¤º `Generator` æ‰§è¡Œå®Œæ¯•ï¼Œè¿”å›ç»“æœã€‚
    res.value.then(function(data) { // å¦åˆ™è¡¨ç¤ºè¿˜æœ‰ä¸‹ä¸€æ­¥éœ€è¦æ‰§è¡Œ
      next(data); // è¿™æ—¶å€™ `res.value` æ˜¯ä¸€ä¸ª `Promise`ï¼Œéœ€è¦ç­‰å¾…å®ƒ `resolve`ï¼Œç„¶åå†æ¬¡è°ƒç”¨ `next` è§¦å‘ä¸‹ä¸€æ­¥æ‰§è¡Œã€‚
    });
  }
  next(); // é€šè¿‡é€’å½’è°ƒç”¨ `next` å‡½æ•°ï¼Œå®ç°è‡ªåŠ¨æŒ‰æ­¥æ‰§è¡Œæ•´ä¸ª `Generator` å‡½æ•°æµç¨‹
}

run(function*() {
  // è°ƒç”¨ `run` æ—¶,ä¼ å…¥ä¸€ä¸ªç¤ºä¾‹ `Generator` å‡½æ•°,è¯¥å‡½æ•° `yield` ä¸¤ä¸ª `Promise`ã€‚
  const res1 = yield Promise.resolve({a: 1});
  console.log(res1);
  // { "a": 1 }
  const res2 = yield Promise.resolve({b: 2});
  console.log(res2);
  // { "b": 2 }
});
// `run` ä¼šè‡ªåŠ¨æ‰§è¡Œè¿™ä¸ª `Generator`ï¼Œå¹¶åœ¨ `Promise resolve` åç»§ç»­æ‰§è¡Œä¸‹ä¸€æ­¥ï¼Œä»è€Œå®ç°å¼‚æ­¥è‡ªåŠ¨æµç¨‹ç®¡ç†ã€‚
```

å¦‚æœæˆ‘ä»¬ç”¨ `async/await` çš„æ–¹å¼å¦‚ä½•å®ç°è¿™ä¸ªæ–¹æ³•å‘¢ï¼Ÿè¯·å¾€ä¸‹çœ‹ï¼š

```JavaScript
// async/await
const aa = async ()=>{
  const res1 = await Promise.resolve({a: 1});
  console.log(res1);

  const res2 = await Promise.resolve({b: 2});
  console.log(res2);
  return 'done';
}

const res = aa();
```

å¯ä»¥çœ‹åˆ°ï¼Œ`async function` ä»£æ›¿äº†` function*`ï¼Œ`await` ä»£æ›¿äº† `yield`ï¼ŒåŒæ—¶ä¹Ÿæ— éœ€è‡ªå·±æ‰‹å†™ä¸€ä¸ªè‡ªåŠ¨æ‰§è¡Œå™¨ `run` äº†

ç°åœ¨å†æ¥çœ‹çœ‹ `async/await` çš„ç‰¹ç‚¹ï¼š

-   å½“ `await` åé¢è·Ÿçš„æ˜¯ `Promise` å¯¹è±¡æ—¶ï¼Œæ‰ä¼šå¼‚æ­¥æ‰§è¡Œï¼Œå…¶å®ƒç±»å‹çš„æ•°æ®ä¼šåŒæ­¥æ‰§è¡Œ
-   æ‰§è¡Œ `const res = aa();` è¿”å›çš„ä»ç„¶æ˜¯ä¸ª `Promise` å¯¹è±¡ï¼Œä¸Šé¢ä»£ç ä¸­çš„ `return 'done'` ä¼šç›´æ¥è¢«ä¸‹é¢ `then` å‡½æ•°æ¥æ”¶åˆ°ï¼š

```JavaScript
res.then(data => {
  console.log(data); // done
});
```

å¥½äº†ï¼Œæœ€åæˆ‘ä»¬åœ¨æ€»ç»“ä¸€ä¸‹ï¼Œ`async/await` ç›¸æ¯” `Promise` å’Œ `Generator`ï¼Œé€šè¿‡ä½¿ç”¨åŒæ­¥ä»£ç çš„æµç¨‹æ§åˆ¶å®ç°å¼‚æ­¥ï¼Œé¿å…äº†å›è°ƒåœ°ç‹±é—®é¢˜å’Œ `Promise` çš„ `then/catch` åµŒå¥—ï¼Œè§£å†³ä¹‹å‰å¼‚æ­¥ä»£ç ç»“æ„å¤æ‚ï¼Œéš¾ä»¥ç»´æŠ¤çš„é—®é¢˜ï¼Œä½¿å¾—ä»£ç æ›´æ¥è¿‘åŒæ­¥ä»£ç å†™æ³•,å¯è¯»æ€§æ›´é«˜ã€‚ç›¸æ¯”èµ·æ˜Ÿå·å’Œ `yield`ï¼Œ`async/await`è¯­ä¹‰æ›´æ¸…æ¥šï¼Œè¿”å›å€¼æ›´ç»Ÿä¸€ã€‚

ğŸ’¡ **ä½†æ˜¯ï¼Œ**æˆ‘ä»¬åœ¨ä½¿ç”¨`async/await`è¿‡ç¨‹ä¸­è¿˜æ˜¯è¦æ³¨æ„å‡ ä¸ªé—®é¢˜ï¼š

-   `await` å‘½ä»¤åé¢çš„ `Promise` å¯¹è±¡ï¼Œè¿è¡Œç»“æœå¯èƒ½æ˜¯ `rejected`ï¼Œæ‰€ä»¥æœ€å¥½æŠŠ `await` å‘½ä»¤æ”¾åœ¨ `try...catch` ä»£ç å—ä¸­ï¼ˆåé¢è¿˜æœ‰å½©è›‹ï¼‰
-   `await` å‘½ä»¤åªèƒ½ç”¨åœ¨ `async` å‡½æ•°ä¹‹ä¸­ï¼Œå¦‚æœç”¨åœ¨æ™®é€šå‡½æ•°ï¼Œå°±ä¼šæŠ¥é”™
-   å¤šä¸ª `await` å‘½ä»¤åé¢çš„å¼‚æ­¥æ“ä½œï¼Œå¦‚æœä¸å­˜åœ¨ç»§å‘å…³ç³»ï¼Œæœ€å¥½è®©å®ƒä»¬åŒæ—¶è§¦å‘ï¼ˆ`Promise.all`ï¼‰
-   åœ¨å¾ªç¯ä¸­éœ€æ³¨æ„å®ƒçš„ä½¿ç”¨ï¼Œå°½é‡åœ¨ `for/for..of`ï¼ˆè¿­ä»£éå†å™¨ï¼‰ ä¸­ä½¿ç”¨ï¼Œæ°¸è¿œä¸è¦åœ¨ `forEach/filter` ä¸­ä½¿ç”¨ï¼Œä¹Ÿå°½é‡ä¸è¦åœ¨ `map` ä¸­ä½¿ç”¨
-   å…¼å®¹æ€§ä¸å¤ªå¥½ï¼Œå½“ç„¶ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¯ä»¥å€ŸåŠ©ç¼–è¯‘å·¥å…·æ¥è¿›è¡Œ `polyfill` æˆ– `es6-shim`
-   å¯ä»¥åœ¨ç”Ÿå‘½å‘¨æœŸå‡½æ•°ä¸­ä½¿ç”¨
-   é”™è¯¯æ•è·ï¼šéœ€è¦æ•è·å¤šä¸ªé”™è¯¯å¹¶åšä¸åŒçš„å¤„ç†æ—¶ï¼Œå¯ä»¥è€ƒè™‘ç»™ `await` åçš„ `promise` å¯¹è±¡æ·»åŠ  `catch` å‡½æ•°

#### ğŸ¥š å½©è›‹

æˆ‘ä»¬å®ç°ä¸€ä¸ª `to` å‡½æ•°,å¯ä»¥å°† `Promise` è½¬æ¢ä¸ºç¬¦åˆ `async/await` è¯­æ³•çš„ç»“æ„ï¼Œæ–¹ä¾¿æˆ‘ä»¬åœ¨ `async/await` ä¸­å¤„ç† `Promise` çš„ç»“æœï¼ŒåŒæ—¶ä¹Ÿä¸éœ€è¦å†æ˜¾å¼åœ°å†™å¤šå±‚ `then/catch` åµŒå¥—ï¼Œç®€åŒ–äº†å¼‚æ­¥ä»£ç çš„å¤„ç†ï¼š

```JavaScript
// to.js
export default function to(promise) { // `to` å‡½æ•°æ¥æ”¶ä¸€ä¸ª `Promise` å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œå¹¶å°† `Promise` ç»“æœè½¬æ¢ä¸ºä¸€ä¸ªç»Ÿä¸€çš„æ•°ç»„ç»“æ„
  return promise.then(data => {
    return [null, data]; // åœ¨å†…éƒ¨,è°ƒç”¨è¯¥ `Promise` çš„ `then` æ–¹æ³•,å¦‚æœæˆåŠŸ,è¿”å›ä¸€ä¸ªæ•°ç»„ `[null, data]`
  })
  .catch(err => [err]); // å¦‚æœ `Promise` è¢« `reject`,åˆ™åœ¨ `catch` ä¸­è¿”å› `[err]`
}

/***ä½¿ç”¨***/
import to from './to';
async function asyncTask() {
  const [err1, res1] = await to(fn1); // åœ¨ `async` å‡½æ•°ä¸­,ä½¿ç”¨ `await to(promise)` çš„æ–¹å¼è°ƒç”¨ï¼Œå¯ä»¥è·å–æ•°ç»„è§£æ„çš„ç»“æœ `[err, data]`ï¼Œå¦‚æœ `data` å­˜åœ¨,è¡¨ç¤º `Promise resolve`,å¯ä»¥ç›´æ¥ä½¿ç”¨
  if(!res1) throw new Error('No res1 found');
  const [err2, res2] = await to(fn2);
  if(err) throw new Error('Error occurred while task2'); // // å¦‚æœ err å­˜åœ¨,è¡¨ç¤º Promise reject,å¯ä»¥ throw è‡ªå®šä¹‰é”™è¯¯
}

```
